<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/default2}">
	  
	<!-- css file import head태그 안에 추가  -->
	<head>
		 <title th:text="${title}">페이지 타이틀</title>
		<!-- This Page CSS -->
		<style>
			.table-bordered, .table-bordered td, .table-bordered th {
				border-color: #bac6d0 !important;
			}
			.table-bordered thead{
				background-color: #dfe4fa !important;
				border-color: #bac6d0;
			}
			.border{
				border-color: #bac6d0 !important;
			}
			
		</style>
	</head>
	
	<!-- This Page breadcrumbTitle -->
	<th:block layout:fragment="customBreadcrumbTitle">
		  <h4 class="page-title text-truncate text-dark font-weight-medium mb-3 h2" th:text="${title}">Default Title</h4>
	</th:block>
	
	<!-- This Page breadcrumb -->
	<th:block layout:fragment="customBreadcrumb">
		<li class="breadcrumb-item">
			<a th:href="@{http://localhost/admin/member/getMember}" class="text-muted h4">회원목록</a>
		</li>
		<li class="breadcrumb-item text-muted active h4" aria-current="page">회원검색</li>
	</th:block>

	<!-- Start Page Content -->
	<th:block layout:fragment="customContent">
       	  <div class="card mb-4">
		    <div class="card-body">
		      <div class="row">
		        <div class="col-lg-10">
		          <div class="row mb-3">
					  <div class="col-12">
						  
		            	<div class="search">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <label class="form-label card-title font-weight-bolder">회원구분</label>
                                        <div class="input-group">
                                            <select id="searchKey" class="form-control text-center">
                                                <option value="memberId">아이디</option>
                                                <option value="memberName">이름</option>
                                                <option value="memberPhone">전화번호</option>
                                                <option value="memberEmail">이메일</option>
                                                <option value="memberBirth">생년월일</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <label class="form-label card-title font-weight-bolder">검색</label>
                                        <div class="input-group">
                                            <input id="searchValue" placeholder="검색어를 작성해주세요" type="text" class="form-control">
                                        </div>
		            </div>
		        </div>
            </div>
            </div>
            </div>
				</div>
	        <div class="col-lg-2 align-self-center">
				<div class="row justify-content-center">
					<div class="col-12">
		              <button id="searchBtn" class="btn btn-primary form-control col-sm-12 font-weight-bold" type="button">
                            	<i class="fas fa-search">&ensp;검색</i>
		              </button>
					</div>
	    	</div>
	      </div>
    	 </div>
	     </div>
		 <div class="card mb-4">
		    <div class="card-body">
		    	<div class="row mb-3">
		    		<div class="col-sm-3 d-flex align-items-end">		    		
				    	<h5 class="card-title">
					    	[ 전체 &nbsp;
					    	<label id="listCnt" class="text-info mb-0">100</label> 건
					    	&nbsp;|&nbsp;  
					    	<label id="pageCnt" class="text-info mb-0">10</label> 건
					    	]
				    	</h5>
		    		</div>	    	
			    	<div class="col-sm-9">
			    		<div class="btn-list text-right">
                           <a type="button" class="btn btn-outline-success" id="addBtn" th:href="@{/admin/member/addMember}"><i class="fas fas fa-pencil-alt"></i>
                               등록</a>
                           <button type="button" class="btn btn-outline-warning" id="modifyBtn"><i class="fas fa-undo"></i>
                               수정</button>
                           <button type="button" class="btn btn-outline-danger" id="delBtn"><i class="fas fa-trash-alt"></i>
                               삭제</button>
                       </div>
			    	</div>
		    	</div>
		    	
		    	<table class="table table-bordered table-hover text-center search-result">
                  <thead class="h5 text-dark">
                      <tr>
                      	  <th style="width: 5%;">
                            <input type="checkbox" id="allCheck">
                      	  </th>
                         	<th class="font-weight-bolder">아이디</th>
                          	<th class="font-weight-bolder">비번</th>
                         	<th class="font-weight-bolder">이름</th>
							<th class="font-weight-bolder">생년월일</th>
							<th class="font-weight-bolder">이메일</th>
							<th class="font-weight-bolder">성별</th>
							<th class="font-weight-bolder">전화번호</th>
							<th class="font-weight-bolder">주소</th>
							<th class="font-weight-bolder">적립등급</th>
							<th class="font-weight-bolder">마일리지</th>
							<th class="font-weight-bolder">회원 등록시간</th>
							
                      </tr>
                  </thead>
                  <tbody id="tbody" class="border text-dark">
                                          <tr th:if="${userList != null and not #lists.isEmpty(userList)}"
												th:each="l : ${userList}">
												<td style="width: 5%;">
                            						<input type="checkbox" class="check">
                      	  						</td>
												<td th:text="${l.memberId}"></td>
												<td th:text="${l.memberPw}"></td>
												<td th:text="${l.memberName}"></td>
												<td th:text="${l.memberBirth}"></td>
												<td th:text="${l.memberEmail}"></td>
												<td th:text="${l.memberGender}"></td>
												<td th:text="${l.memberPhone}"></td>
												<td th:text="${l.memberAddr + ' ' + l.member_addr_detail}"></td>
	<!--											<td th:text="${l.memberAddr}"></td>
												<td th:text="${l.member_addr_detail}"></td>-->
												<th:block th:object="${l.roompayMileageRate}">
												<td th:text="${l.roompayMileageRate?.mileage_grade_name}"></td>
												</th:block>	
											<!--	<td th:if="${memberMileageList != null and not #lists.isEmpty(memberMileageList)}"
												th:each="ml : ${memberMileageList}">
												<td th:text="${ml.mileage_grade_name}">
												</td>
												</td>-->
												<td th:text="${l.memberMileage}"></td>
												<td th:text="${l.memberRegDate}"></td>
						
                                        </tr>
                                        <tr th:unless="${userList != null and not #lists.isEmpty(userList)}">
											<td colspan="12">등록된 회원의 정보가 없습니다.</td>
										</tr>
                                    </tbody>
                                </table>
			    <div class="row justify-content-center mt-5">
			    	<div class="col-10">			    	
				    	<ul class="pagination justify-content-center">
		                   <li class="page-item disabled">
		                       <a class="page-link" href="#" tabindex="-1">Previous</a>
		                   </li>
		                   <li class="page-item active"><a class="page-link" href="#">1</a></li>
		                   <li class="page-item"><a class="page-link" href="#">2</a></li>
		                   <li class="page-item">
		                       <a class="page-link" href="#">Next</a>
		                   </li>
		               </ul>
			    	</div>
			    </div>
		    </div>
		    </div>
		  </div>
	
		  <!-- search modal content -->
	</th:block>
	<th:block layout:fragment="customJs">
		<script th:inline="javascript">
		// model 객체 데이터(msg) 바인딩
		let msg = [[${msg}]];
		if(msg) alert(msg);
		
		$('#searchBtn').click(function(){
			const searchValue = $('#searchValue').val();
			
			if(searchValue == null || searchValue == '') return;
			
			// 검색 객체 생성
			//const searchArr = [];
			const searchObj = {};
			// 검색 항목 객체 속성 동적 삽입
			$('.search select, .search input').each(function(idx, item){
				//const searchObj = {};
				searchObj[item.id] = $(item).val();
				//searchArr.push(searchObj);
			});
			
			console.log(searchObj);
			//console.log(searchArr);
			
			const request = $.ajax({
				url : '/admin/member/searchForUserList',
				method : 'POST',
				contentType : 'application/json; charset=UTF-8',
				data: JSON.stringify(searchObj),
				//data: JSON.stringify(searchArr),
				dataType: 'JSON'
			});
			request.done(function(res){
				console.log(res)
				const searchList = res;
				$('#tbody').html(''); // tbody 초기화
				
				// 검색항목에 일치된 목록이 없을 경우
				if(searchList == null || searchList.length < 1){
					const newTr = $('<tr />');
					const newTd = $('<td />',{'colspan': 10}).text('검색에 일치되는 내용이 없습니다.');
					newTr.append(newTd);
					$('#tbody').append(newTr);
					return ;
				}
				
				// 검색항목에 일치된 목록이 있을 경우
				$(searchList).each(function(idx, item) {
				    const newTr = $('<tr />');
				    const checkbox = $('<input />', {
				        type: 'checkbox',
				        class: 'check'
				    });
				 //주소+상세주소   
		   		const addressString = item.memberAddr + ' ' + item.member_addr_detail;
				const newTdCombinedAddress = $('<td />').text(addressString);
				const memberId = item.memberId;
				
				const newTdMemberId = $('<td />').text(item.memberId);
				const newTdMemberPw = $('<td />').text(item.memberPw);
				const newTdMemberName = $('<td />').text(item.memberName);
				const newTdmemberBirth = $('<td />').text(item.memberBirth);
				const newTdMemberEmail = $('<td />').text(item.memberEmail);
				const newTdmemberGender = $('<td />').text(item.memberGender);
				const newTdmemberPhone = $('<td />').text(item.memberPhone);
				const newTdmileage_grade_name = $('<td />').text(item.mileage_grade_name);
				const newTdfinal_mileage = $('<td />').text(item.final_mileage);
				const newTdMemberRegDate = $('<td />').text(item.memberRegDate);
				
				newTr.append(
				    $('<td />').append(checkbox),
				    newTdMemberId,
				    newTdMemberPw,
				    newTdMemberName,
				    newTdmemberBirth,
				    newTdMemberEmail,
				    newTdmemberGender,
				    newTdmemberPhone,
				    newTdCombinedAddress,  // 주소+상세주소
				    newTdmileage_grade_name, // 조회안됨
				    newTdfinal_mileage,
				    newTdMemberRegDate
				);

$('#tbody').append(newTr);



				});

				
			});
			request.fail(function(jQXHR, textStatus, error){
				console.log(error);
			});
		});
		
		
			// 검색결과 tbody check box 이벤트
			$(document).on('click', '.check', function(e){
				e.stopPropagation();
				if($('.check').length == $('.check:checked').length){
					$('#allCheck').prop('checked', true);
				}else{
					$('#allCheck').prop('checked', false);
				}
			});
			
			// 전체체크
			$(document).on('click', '#allCheck', function(){
				const isChecked = $(this).prop('checked');
				$('.check').prop('checked', isChecked);
			});	
			
			 // 수정버튼
        $(document).on('click', '#modifyBtn', function(){
            const checkedCheckboxes = $('.check:checked');

            // 체크된 체크박스가 하나인 경우에만 실행
            if (checkedCheckboxes.length === 1) {
                const memberId = checkedCheckboxes.closest('tr').find('td:eq(1)').text();
                window.location.href = '/admin/member/modifyMember?memberId=' + memberId;
            } else {
                alert('한 개의 회원만 선택해주세요.');
            }
        });
        
     // 삭제 버튼 클릭 이벤트
$(document).on('click', '#delBtn', function() {
    const checkedCheckboxes = $('.check:checked');

    // 체크된 체크박스가 하나 이상인 경우에만 실행
    if (checkedCheckboxes.length > 0) {
        if (confirm('정말로 선택한 회원을 삭제하시겠습니까?')) {
            // 선택된 모든 체크박스에 대해 반복
            checkedCheckboxes.each(function() {
                const memberId = $(this).closest('tr').find('td:eq(1)').text();

                // 서버에 DELETE 요청을 보내 회원을 삭제합니다.
                fetch('/admin/member/removeMember/' + memberId, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        // 회원이 삭제되면 해당 행을 삭제
                        $(this).closest('tr').remove();
                    } else {
                        alert('회원 삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('회원 삭제에 실패했습니다.');
                });
            });

            // 모든 처리가 완료되면 페이지 리로드
            window.location.reload();
        }
    } else {
        alert('삭제할 회원을 선택해주세요.');
    }
});

			
		</script>
	</th:block>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</html>